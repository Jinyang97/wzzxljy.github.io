<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D sp³杂化轨道与CH4分子形成过程</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2a3c7f);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #ff7e5f, #feb47b);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #b3c7ff;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .visualization {
            flex: 1;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .canvas-container {
            position: relative;
            width: 100%;
            height: 400px;
            margin: 20px 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }
        
        #threeCanvas {
            width: 100%;
            height: 100%;
        }
        
        .hybridization-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .orbitals-row {
            display: flex;
            justify-content: space-around;
            width: 100%;
            gap: 10px;
        }
        
        .orbital-item {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .orbital-canvas {
            width: 100%;
            height: 150px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
        }
        
        .orbital-label {
            font-size: 14px;
            color: #b3c7ff;
            margin-top: 5px;
        }
        
        .arrow-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px 0;
        }
        
        .arrow-down {
            font-size: 40px;
            color: #ff7e5f;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .arrow-text {
            font-size: 16px;
            color: #ff7e5f;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            gap: 10px;
        }
        
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(90deg, #4a6ee0, #6a8aff);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            background: linear-gradient(90deg, #5a7ef0, #7a9aff);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .explanation {
            flex: 1;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            position: relative;
        }
        
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.2);
            z-index: 1;
        }
        
        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #3a4a8c;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .step.active {
            background: linear-gradient(135deg, #ff7e5f, #feb47b);
            transform: scale(1.2);
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h2 {
            margin-bottom: 15px;
            color: #ff9e7d;
            font-size: 1.8rem;
        }
        
        h3 {
            margin: 20px 0 10px;
            color: #b3c7ff;
        }
        
        p {
            margin-bottom: 15px;
        }
        
        .orbital-diagram {
            display: flex;
            flex-direction: column;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            position: relative;
        }
        
        .energy-level {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            position: relative;
            height: 40px;
        }
        
        .energy-label {
            width: 100px;
            font-weight: bold;
            color: #b3c7ff;
            font-size: 16px;
        }
        
        .energy-line {
            flex: 1;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            margin: 0 10px;
        }
        
        .orbital-box {
            width: 80px;
            height: 40px;
            border: 2px solid #6a8aff;
            border-radius: 5px;
            margin-right: 15px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .orbital-label {
            position: absolute;
            bottom: -25px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 14px;
            color: #b3c7ff;
        }
        
        .electron {
            position: absolute;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }
        
        .electron.up {
            color: #4cd964;
        }
        
        .electron.down {
            color: #ff7e5f;
            transform: rotate(180deg);
        }
        
        .original-orbitals {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.3;
        }
        
        .original-orbitals .energy-level {
            margin-bottom: 25px;
        }
        
        .concept-box {
            background: rgba(255, 255, 255, 0.08);
            border-left: 4px solid #ff7e5f;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #b3c7ff;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .orbital-box {
                width: 60px;
                height: 30px;
                margin-right: 10px;
            }
            
            .electron {
                width: 20px;
                height: 20px;
                font-size: 16px;
            }
            
            .orbitals-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>3D sp³杂化轨道与CH₄分子形成过程</h1>
            <p class="subtitle">探索碳原子如何通过轨道杂化与四个氢原子形成稳定的甲烷分子</p>
        </header>
        
        <div class="content">
            <div class="visualization">
                <h2>3D分子结构可视化</h2>
                <div class="canvas-container">
                    <div id="threeCanvas"></div>
                </div>
                
                <div id="hybridizationStep" class="hybridization-container" style="display: none;">
                    <div class="orbitals-row">
                        <div class="orbital-item">
                            <div class="orbital-canvas" id="sOrbitalCanvas"></div>
                            <div class="orbital-label">2s轨道</div>
                        </div>
                        <div class="orbital-item">
                            <div class="orbital-canvas" id="pxOrbitalCanvas"></div>
                            <div class="orbital-label">2pₓ轨道</div>
                        </div>
                        <div class="orbital-item">
                            <div class="orbital-canvas" id="pyOrbitalCanvas"></div>
                            <div class="orbital-label">2pᵧ轨道</div>
                        </div>
                        <div class="orbital-item">
                            <div class="orbital-canvas" id="pzOrbitalCanvas"></div>
                            <div class="orbital-label">2p_z轨道</div>
                        </div>
                    </div>
                    
                    <div class="arrow-container">
                        <div class="arrow-down">↓</div>
                        <div class="arrow-text">形成杂化轨道</div>
                    </div>
                    
                    <div class="orbitals-row">
                        <div class="orbital-item">
                            <div class="orbital-canvas" id="hybrid1Canvas"></div>
                            <div class="orbital-label">sp³杂化轨道1</div>
                        </div>
                        <div class="orbital-item">
                            <div class="orbital-canvas" id="hybrid2Canvas"></div>
                            <div class="orbital-label">sp³杂化轨道2</div>
                        </div>
                        <div class="orbital-item">
                            <div class="orbital-canvas" id="hybrid3Canvas"></div>
                            <div class="orbital-label">sp³杂化轨道3</div>
                        </div>
                        <div class="orbital-item">
                            <div class="orbital-canvas" id="hybrid4Canvas"></div>
                            <div class="orbital-label">sp³杂化轨道4</div>
                        </div>
                    </div>
                </div>
                
                <div class="controls">
                    <button id="prevBtn">上一步</button>
                    <button id="nextBtn">下一步</button>
                    <button id="resetBtn">重置</button>
                    <button id="autoBtn">自动演示</button>
                </div>
                
                <div class="orbital-diagram">
                    <div class="original-orbitals" id="originalOrbitals"></div>
                    <div class="energy-level">
                        <div class="energy-label">2p轨道</div>
                        <div class="energy-line"></div>
                        <div class="orbital-box" id="p1Orbital">
                            <div class="orbital-label">2pₓ</div>
                        </div>
                        <div class="orbital-box" id="p2Orbital">
                            <div class="orbital-label">2pᵧ</div>
                        </div>
                        <div class="orbital-box" id="p3Orbital">
                            <div class="orbital-label">2p_z</div>
                        </div>
                    </div>
                    <div class="energy-level">
                        <div class="energy-label">sp³杂化</div>
                        <div class="energy-line"></div>
                        <div class="orbital-box" id="hybrid1">
                            <div class="orbital-label">sp³</div>
                        </div>
                        <div class="orbital-box" id="hybrid2">
                            <div class="orbital-label">sp³</div>
                        </div>
                        <div class="orbital-box" id="hybrid3">
                            <div class="orbital-label">sp³</div>
                        </div>
                        <div class="orbital-box" id="hybrid4">
                            <div class="orbital-label">sp³</div>
                        </div>
                    </div>
                    <div class="energy-level">
                        <div class="energy-label">2s轨道</div>
                        <div class="energy-line"></div>
                        <div class="orbital-box" id="sOrbital">
                            <div class="orbital-label">2s</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="explanation">
                <div class="step-indicator">
                    <div class="step active" data-step="1">1</div>
                    <div class="step" data-step="2">2</div>
                    <div class="step" data-step="3">3</div>
                    <div class="step" data-step="4">4</div>
                    <div class="step" data-step="5">5</div>
                    <div class="step" data-step="6">6</div>
                </div>
                
                <div class="step-content active" id="step1">
                    <h2>步骤 1: 碳原子的基态电子排布</h2>
                    <p>碳原子（原子序数6）的电子排布为：1s² 2s² 2p²。</p>
                    <p>在基态下，碳原子的价电子层（第二层）有4个电子：</p>
                    <ul>
                        <li>2s轨道上有2个电子（自旋相反）</li>
                        <li>2p轨道上有2个电子（分别占据2个p轨道）</li>
                    </ul>
                    <div class="concept-box">
                        <strong>关键概念：</strong> 在基态下，碳原子只有2个未成对电子，理论上只能形成2个共价键。但事实上，碳原子通常形成4个共价键，这需要通过轨道杂化来解释。
                    </div>
                </div>
                
                <div class="step-content" id="step2">
                    <h2>步骤 2: 未杂化轨道与氢原子成键</h2>
                    <p>在未杂化状态下，碳原子只能使用含有未成对电子的2pₓ和2pᵧ轨道与氢原子的1s轨道形成化学键。</p>
                    <p>形成的分子为CH₂，其中：</p>
                    <ul>
                        <li>两个C-H键互相垂直，键角约为90°</li>
                        <li>碳原子未达到8电子稳定结构</li>
                        <li>分子能量较高，不稳定</li>
                    </ul>
                    <div class="concept-box">
                        <strong>关键概念：</strong> 未杂化的碳原子形成的CH₂分子键角为90°，且碳原子未达到满壳层结构，这与实际观察到的甲烷分子性质不符，因此需要引入杂化轨道理论来解释。
                    </div>
                </div>
                
                <div class="step-content" id="step3">
                    <h2>步骤 3: 轨道杂化过程</h2>
                    <p>碳原子的一个2s轨道和三个2p轨道混合，形成四个能量相等的新轨道，称为sp³杂化轨道。</p>
                    <p>杂化过程中，四个原始轨道重新组合，形成四个具有相同能量和形状的新轨道。</p>
                    <div class="concept-box">
                        <strong>关键概念：</strong> 杂化轨道理论通过数学上的线性组合，解释了碳原子如何形成四个等同的键，以及甲烷分子为什么具有正四面体结构。
                    </div>
                </div>
                
                <div class="step-content" id="step4">
                    <h2>步骤 4: sp³杂化轨道形成</h2>
                    <p>四个sp³杂化轨道在空间取向上彼此远离，形成正四面体结构，轨道之间的夹角为109.5°。</p>
                    <p>每个sp³杂化轨道含有1/4的s轨道成分和3/4的p轨道成分。</p>
                    <div class="concept-box">
                        <strong>关键概念：</strong> 杂化轨道理论解释了碳原子如何形成四个等同的键，以及甲烷分子为什么具有正四面体结构。
                    </div>
                </div>
                
                <div class="step-content" id="step5">
                    <h2>步骤 5: 与氢原子成键</h2>
                    <p>四个氢原子各提供一个1s电子，与碳原子的四个sp³杂化轨道重叠形成σ键。</p>
                    <p>每个C-H键都是由碳的sp³杂化轨道与氢的1s轨道头对头重叠形成的。</p>
                    <p>由于四个sp³杂化轨道完全相同，四个C-H键的键长和键能也完全相同。</p>
                    <div class="concept-box">
                        <strong>关键概念：</strong> σ键是沿着键轴方向头对头重叠形成的，可以自由旋转而不影响键的强度。
                    </div>
                </div>
                
                <div class="step-content" id="step6">
                    <h2>步骤 6: 甲烷分子形成</h2>
                    <p>最终形成甲烷分子（CH₄），具有正四面体结构：</p>
                    <ul>
                        <li>碳原子位于正四面体的中心</li>
                        <li>四个氢原子位于正四面体的四个顶点</li>
                        <li>所有H-C-H键角均为109.5°</li>
                        <li>所有C-H键长均为1.09 Å</li>
                    </ul>
                    <div class="concept-box">
                        <strong>关键概念：</strong> 甲烷分子的正四面体结构使其非常稳定，并且由于对称性，分子是非极性的。
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>化学教学可视化工具 | 3D sp³杂化轨道与CH₄分子形成过程</p>
        </footer>
    </div>

    <script>
        // Three.js 场景设置
        let scene, camera, renderer;
        let carbonAtom, hydrogenAtoms = [], orbitals = [], bonds = [];
        let animationId = null;
        let currentStep = 1;
        const totalSteps = 6;
        let autoPlayInterval = null;
        let rotationAngle = 0;
        let mouseX = 0, mouseY = 0;
        let isMouseDown = false;
        
        // 杂化步骤相关变量
        let hybridScenes = [];
        let hybridCameras = [];
        let hybridRenderers = [];
        let hybridRotationAngle = 0;
        
        // 全局变量存储步骤指示器和内容元素
        let stepIndicators, stepContents;
        
        // 初始化Three.js场景
        function initThreeJS() {
            // 创建场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a2a6c);
            
            // 创建相机
            const container = document.getElementById('threeCanvas');
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            
            // 设置初始视角：沿垂直于xy平面向z轴抬高45°
            camera.position.set(7, 7, 7);
            camera.lookAt(0, 0, 0);
            
            // 创建渲染器
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            
            // 添加光源
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7);
            scene.add(directionalLight);
            
            // 添加坐标轴
            const axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);
            
            // 初始化原子和轨道
            initAtomsAndOrbitals();
            
            // 添加鼠标事件监听
            setupMouseControls();
            
            // 初始化杂化步骤
            initHybridizationStep();
            
            // 开始动画循环
            animate();
            
            // 窗口大小调整事件
            window.addEventListener('resize', onWindowResize);
        }
        
        // 设置鼠标控制
        function setupMouseControls() {
            const canvas = renderer.domElement;
            
            canvas.addEventListener('mousedown', (event) => {
                isMouseDown = true;
                mouseX = event.clientX;
                mouseY = event.clientY;
            });
            
            canvas.addEventListener('mousemove', (event) => {
                if (!isMouseDown) return;
                
                const deltaX = event.clientX - mouseX;
                const deltaY = event.clientY - mouseY;
                
                rotationAngle += deltaX * 0.01;
                
                mouseX = event.clientX;
                mouseY = event.clientY;
            });
            
            canvas.addEventListener('mouseup', () => {
                isMouseDown = false;
            });
            
            canvas.addEventListener('wheel', (event) => {
                camera.position.z += event.deltaY * 0.01;
                camera.position.z = Math.max(5, Math.min(20, camera.position.z));
            });
        }
        
        // 初始化原子和轨道
        function initAtomsAndOrbitals() {
            // 创建碳原子 - 增大尺寸
            const carbonGeometry = new THREE.SphereGeometry(1.0, 32, 32); // 从0.5增加到1.0
            const carbonMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xff7e5f,
                shininess: 100
            });
            carbonAtom = new THREE.Mesh(carbonGeometry, carbonMaterial);
            scene.add(carbonAtom);
            
            // 创建氢原子（初始隐藏）
            for (let i = 0; i < 4; i++) {
                const hydrogenGeometry = new THREE.SphereGeometry(0.8, 32, 32);
                const hydrogenMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0x3498db,
                    shininess: 100
                });
                const hydrogenAtom = new THREE.Mesh(hydrogenGeometry, hydrogenMaterial);
                hydrogenAtom.visible = false;
                scene.add(hydrogenAtom);
                hydrogenAtoms.push(hydrogenAtom);
            }
            
            // 创建化学键（初始隐藏）
            for (let i = 0; i < 4; i++) {
                const bondGeometry = new THREE.CylinderGeometry(0.05, 0.05, 1, 8);
                const bondMaterial = new THREE.MeshPhongMaterial({ color: 0x4cd964 });
                const bond = new THREE.Mesh(bondGeometry, bondMaterial);
                bond.visible = false;
                scene.add(bond);
                bonds.push(bond);
            }
        }
        
        // 初始化杂化步骤
        function initHybridizationStep() {
            const orbitalIds = ['sOrbitalCanvas', 'pxOrbitalCanvas', 'pyOrbitalCanvas', 'pzOrbitalCanvas', 
                               'hybrid1Canvas', 'hybrid2Canvas', 'hybrid3Canvas', 'hybrid4Canvas'];
            
            orbitalIds.forEach((id, index) => {
                const container = document.getElementById(id);
                const width = container.clientWidth;
                const height = container.clientHeight;
                
                // 创建场景
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x1a2a6c);
                
                // 创建相机
                const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
                camera.position.set(4, 4, 4);
                camera.lookAt(0, 0, 0);
                
                // 创建渲染器
                const renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(width, height);
                container.appendChild(renderer.domElement);
                
                // 添加光源
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(5, 10, 7);
                scene.add(directionalLight);
                
                // 添加坐标轴
                const axesHelper = new THREE.AxesHelper(2);
                scene.add(axesHelper);
                
                // 根据索引创建不同的轨道
                if (index < 4) {
                    // 原始轨道
                    if (index === 0) {
                        // 2s轨道 - 球形
                        const sGeometry = new THREE.SphereGeometry(0.8, 16, 16);
                        const sMaterial = new THREE.MeshPhongMaterial({ 
                            color: 0x6a8aff,
                            transparent: true,
                            opacity: 0.7
                        });
                        const sOrbital = new THREE.Mesh(sGeometry, sMaterial);
                        scene.add(sOrbital);
                    } else {
                        // p轨道
                        const colors = [0xff0000, 0x00ff00, 0x0000ff];
                        const directions = [
                            new THREE.Vector3(1, 0, 0),
                            new THREE.Vector3(0, 1, 0), 
                            new THREE.Vector3(0, 0, 1)
                        ];
                        
                        const geometry = new THREE.SphereGeometry(0.4, 16, 16);
                        const scaleX = directions[index-1].x !== 0 ? 2.5 : 1;
                        const scaleY = directions[index-1].y !== 0 ? 2.5 : 1;
                        const scaleZ = directions[index-1].z !== 0 ? 2.5 : 1;
                        geometry.scale(scaleX, scaleY, scaleZ);
                        
                        const material = new THREE.MeshPhongMaterial({ 
                            color: colors[index-1],
                            transparent: true,
                            opacity: 0.7,
                            side: THREE.DoubleSide
                        });
                        
                        const orbital1 = new THREE.Mesh(geometry, material);
                        orbital1.position.copy(directions[index-1].clone().multiplyScalar(1.5));
                        scene.add(orbital1);
                        
                        const orbital2 = new THREE.Mesh(geometry, material);
                        orbital2.position.copy(directions[index-1].clone().multiplyScalar(-1.5));
                        scene.add(orbital2);
                    }
                } else {
                    // sp³杂化轨道
                    const hybridDirections = [
                        new THREE.Vector3(1, 1, 1).normalize(),
                        new THREE.Vector3(-1, 1, -1).normalize(),
                        new THREE.Vector3(1, -1, -1).normalize(),
                        new THREE.Vector3(-1, -1, 1).normalize()
                    ];
                    
                    const geometry = new THREE.SphereGeometry(0.5, 16, 16);
                    geometry.scale(1.5, 1.5, 2.5);
                    
                    const material = new THREE.MeshPhongMaterial({ 
                        color: 0xff7e5f,
                        transparent: true,
                        opacity: 0.7,
                        side: THREE.DoubleSide
                    });
                    
                    const orbital = new THREE.Mesh(geometry, material);
                    orbital.position.copy(hybridDirections[index-4].clone().multiplyScalar(1.5));
                    orbital.lookAt(new THREE.Vector3(0, 0, 0));
                    scene.add(orbital);
                }
                
                hybridScenes.push(scene);
                hybridCameras.push(camera);
                hybridRenderers.push(renderer);
            });
        }
        
        // 创建p轨道 - 使用椭球体，增大尺寸
        function createPOrbitals() {
            // 清除现有轨道
            orbitals.forEach(orbital => scene.remove(orbital));
            orbitals = [];
            
            // p轨道方向
            const directions = [
                new THREE.Vector3(1, 0, 0),  // p_x
                new THREE.Vector3(0, 1, 0),  // p_y
                new THREE.Vector3(0, 0, 1)   // p_z
            ];
            
            // 轨道颜色
            const colors = [0xff0000, 0x00ff00, 0x0000ff];
            
            // 创建p轨道
            directions.forEach((dir, index) => {
                // 创建椭球体轨道 - 增大尺寸，变得更"胖"
                const geometry = new THREE.SphereGeometry(0.6, 16, 16);
                
                // 创建缩放矩阵使椭球体沿轴向拉长
                const scaleX = dir.x !== 0 ? 2.5 : 1.5;
                const scaleY = dir.y !== 0 ? 2.5 : 1.5;
                const scaleZ = dir.z !== 0 ? 2.5 : 1.5;
                
                geometry.scale(scaleX, scaleY, scaleZ);
                
                const material = new THREE.MeshPhongMaterial({ 
                    color: colors[index],
                    transparent: true,
                    opacity: 0.7,
                    side: THREE.DoubleSide
                });
                
                // 创建两个对称的椭球体轨道
                const orbital1 = new THREE.Mesh(geometry, material);
                orbital1.position.copy(dir.clone().multiplyScalar(2.0));
                
                const orbital2 = new THREE.Mesh(geometry, material);
                orbital2.position.copy(dir.clone().multiplyScalar(-2.0));
                
                scene.add(orbital1);
                scene.add(orbital2);
                orbitals.push(orbital1);
                orbitals.push(orbital2);
            });
        }
        
        // 创建sp³杂化轨道 - 使用椭球体
        function createHybridOrbitals() {
            // 清除现有轨道
            orbitals.forEach(orbital => scene.remove(orbital));
            orbitals = [];
            
            // 四个sp³杂化轨道方向（正四面体）
            const directions = [
                new THREE.Vector3(1, 1, 1).normalize(),
                new THREE.Vector3(-1, 1, -1).normalize(),
                new THREE.Vector3(1, -1, -1).normalize(),
                new THREE.Vector3(-1, -1, 1).normalize()
            ];
            
            // 杂化轨道颜色（与3D模型一致）
            const hybridColor = 0xff7e5f;
            
            // 创建杂化轨道
            directions.forEach((dir, index) => {
                // 创建椭球体轨道 - 沿轴向拉长
                const geometry = new THREE.SphereGeometry(0.6, 16, 16);
                
                // 创建缩放矩阵使椭球体沿轴向拉长
                geometry.scale(1.8, 1.8, 2.8);
                
                const material = new THREE.MeshPhongMaterial({ 
                    color: hybridColor,
                    transparent: true,
                    opacity: 0.7,
                    side: THREE.DoubleSide
                });
                
                const orbital = new THREE.Mesh(geometry, material);
                orbital.position.copy(dir.clone().multiplyScalar(2.0));
                
                // 旋转轨道使其指向正确方向
                orbital.lookAt(new THREE.Vector3(0, 0, 0));
                
                scene.add(orbital);
                orbitals.push(orbital);
            });
        }
        
        // 更新场景
        function updateScene() {
            // 清除现有轨道
            orbitals.forEach(orbital => scene.remove(orbital));
            orbitals = [];
            
            // 隐藏氢原子和化学键
            hydrogenAtoms.forEach(atom => atom.visible = false);
            bonds.forEach(bond => bond.visible = false);
            
            // 显示或隐藏杂化步骤
            const hybridizationContainer = document.getElementById('hybridizationStep');
            const mainCanvas = document.getElementById('threeCanvas').parentElement;
            
            if (currentStep === 3) {
                hybridizationContainer.style.display = 'block';
                mainCanvas.style.display = 'none';
            } else {
                hybridizationContainer.style.display = 'none';
                mainCanvas.style.display = 'block';
            }
            
            // 根据当前步骤更新场景
            switch(currentStep) {
                case 1:
                    // 显示碳原子
                    carbonAtom.visible = true;
                    // 显示基态碳原子和p轨道
                    createPOrbitals();
                    break;
                case 2:
                    // 显示碳原子
                    carbonAtom.visible = true;
                    // 显示未杂化轨道与氢原子成键 - 不显示化学键
                    createPOrbitals();
                    
                    // 显示两个氢原子
                    hydrogenAtoms[0].visible = true;
                    hydrogenAtoms[0].position.set(4, 0, 0);
                    hydrogenAtoms[1].visible = true;
                    hydrogenAtoms[1].position.set(0, 4, 0);
                    
                    // 不显示化学键
                    break;
                case 3:
                    // 杂化步骤 - 在initHybridizationStep中处理
                    break;
                case 4:
                    // 隐藏碳原子
                    carbonAtom.visible = false;
                    // 显示sp³杂化轨道
                    createHybridOrbitals();
                    break;
                case 5:
                    // 隐藏碳原子
                    carbonAtom.visible = false;
                    // 显示sp³杂化轨道和氢原子
                    createHybridOrbitals();
                    
                    // 显示氢原子
                    const directions = [
                        new THREE.Vector3(1, 1, 1).normalize(),
                        new THREE.Vector3(-1, 1, -1).normalize(),
                        new THREE.Vector3(1, -1, -1).normalize(),
                        new THREE.Vector3(-1, -1, 1).normalize()
                    ];
                    
                    hydrogenAtoms.forEach((atom, index) => {
                        atom.visible = true;
                        atom.position.copy(directions[index].clone().multiplyScalar(4));
                    });
                    break;
                case 6:
                    // 隐藏碳原子
                    carbonAtom.visible = false;
                    // 显示甲烷分子
                    createHybridOrbitals();
                    
                    // 显示氢原子和化学键
                    const bondDirections = [
                        new THREE.Vector3(1, 1, 1).normalize(),
                        new THREE.Vector3(-1, 1, -1).normalize(),
                        new THREE.Vector3(1, -1, -1).normalize(),
                        new THREE.Vector3(-1, -1, 1).normalize()
                    ];
                    
                    hydrogenAtoms.forEach((atom, index) => {
                        atom.visible = true;
                        atom.position.copy(bondDirections[index].clone().multiplyScalar(3.5));
                    });
                    
                    bonds.forEach((bond, index) => {
                        bond.visible = true;
                        
                        // 设置化学键位置和方向
                        const direction = bondDirections[index];
                        bond.position.copy(direction.clone().multiplyScalar(1.75));
                        
                        // 设置化学键方向
                        bond.lookAt(new THREE.Vector3(0, 0, 0));
                        bond.rotateX(Math.PI / 2);
                        
                        // 设置化学键长度
                        bond.scale.set(1, 3.5, 1);
                    });
                    break;
            }
            
            // 更新轨道图
            updateOrbitalDiagram(currentStep);
        }
        
        // 更新轨道图
        function updateOrbitalDiagram(step) {
            // 重置所有轨道
            sOrbital.innerHTML = '<div class="orbital-label">2s</div>';
            p1Orbital.innerHTML = '<div class="orbital-label">2pₓ</div>';
            p2Orbital.innerHTML = '<div class="orbital-label">2pᵧ</div>';
            p3Orbital.innerHTML = '<div class="orbital-label">2p_z</div>';
            hybrid1.innerHTML = '<div class="orbital-label">sp³</div>';
            hybrid2.innerHTML = '<div class="orbital-label">sp³</div>';
            hybrid3.innerHTML = '<div class="orbital-label">sp³</div>';
            hybrid4.innerHTML = '<div class="orbital-label">sp³</div>';
            
            // 设置sp³杂化轨道颜色（与3D模型一致）
            const hybridColor = '#ff7e5f';
            hybrid1.style.borderColor = hybridColor;
            hybrid2.style.borderColor = hybridColor;
            hybrid3.style.borderColor = hybridColor;
            hybrid4.style.borderColor = hybridColor;
            
            // 隐藏所有杂化轨道
            hybrid1.parentElement.style.display = 'none';
            hybrid2.parentElement.style.display = 'none';
            hybrid3.parentElement.style.display = 'none';
            hybrid4.parentElement.style.display = 'none';
            
            // 显示所有轨道
            sOrbital.parentElement.style.display = 'flex';
            p1Orbital.parentElement.style.display = 'flex';
            p2Orbital.parentElement.style.display = 'flex';
            p3Orbital.parentElement.style.display = 'flex';
            
            // 设置p轨道颜色
            p1Orbital.style.borderColor = '#ff0000';
            p2Orbital.style.borderColor = '#00ff00';
            p3Orbital.style.borderColor = '#0000ff';
            
            // 清除原始轨道显示
            document.getElementById('originalOrbitals').innerHTML = '';
            
            if (step === 1) {
                // 步骤1：基态电子排布
                sOrbital.innerHTML = '<div class="orbital-label">2s</div><div class="electron up" style="left: 20px;">↑</div><div class="electron down" style="right: 20px;">↑</div>';
                p1Orbital.innerHTML = '<div class="orbital-label">2pₓ</div><div class="electron up" style="left: 20px;">↑</div>';
                p2Orbital.innerHTML = '<div class="orbital-label">2pᵧ</div><div class="electron up" style="left: 20px;">↑</div>';
            } else if (step === 2) {
                // 步骤2：未杂化轨道与氢原子成键
                sOrbital.innerHTML = '<div class="orbital-label">2s</div><div class="electron up" style="left: 20px;">↑</div><div class="electron down" style="right: 20px;">↑</div>';
                p1Orbital.innerHTML = '<div class="orbital-label">2pₓ</div><div class="electron up" style="left: 20px;">↑</div>';
                p2Orbital.innerHTML = '<div class="orbital-label">2pᵧ</div><div class="electron up" style="left: 20px;">↑</div>';
            } else if (step === 3) {
                // 步骤3：杂化过程 - 只显示轨道方框，不显示电子
                hybrid1.parentElement.style.display = 'flex';
                hybrid2.parentElement.style.display = 'flex';
                hybrid3.parentElement.style.display = 'flex';
                hybrid4.parentElement.style.display = 'flex';
                
                // 显示原始轨道能量位置
                const originalOrbitals = document.getElementById('originalOrbitals');
                
                // 添加2p轨道（最高能量）
                const pLevel = document.createElement('div');
                pLevel.className = 'energy-level';
                pLevel.innerHTML = `
                    <div class="energy-label" style="color: rgba(179, 199, 255, 0.5)">2p轨道</div>
                    <div class="energy-line" style="background: rgba(255, 255, 255, 0.15)"></div>
                    <div class="orbital-box" style="border-color: rgba(255, 0, 0, 0.5); background: rgba(255, 0, 0, 0.1)">
                        <div class="orbital-label" style="color: rgba(179, 199, 255, 0.5)">2pₓ</div>
                    </div>
                    <div class="orbital-box" style="border-color: rgba(0, 255, 0, 0.5); background: rgba(0, 255, 0, 0.1)">
                        <div class="orbital-label" style="color: rgba(179, 199, 255, 0.5)">2pᵧ</div>
                    </div>
                    <div class="orbital-box" style="border-color: rgba(0, 0, 255, 0.5); background: rgba(0, 0, 255, 0.1)">
                        <div class="orbital-label" style="color: rgba(179, 199, 255, 0.5)">2p_z</div>
                    </div>
                `;
                originalOrbitals.appendChild(pLevel);
                
                // 添加2s轨道（最低能量）
                const sLevel = document.createElement('div');
                sLevel.className = 'energy-level';
                sLevel.innerHTML = `
                    <div class="energy-label" style="color: rgba(179, 199, 255, 0.5)">2s</div>
                    <div class="energy-line" style="background: rgba(255, 255, 255, 0.15)"></div>
                    <div class="orbital-box" style="border-color: rgba(106, 138, 255, 0.5); background: rgba(106, 138, 255, 0.1)">
                        <div class="orbital-label" style="color: rgba(179, 199, 255, 0.5)">2s</div>
                    </div>
                `;
                originalOrbitals.appendChild(sLevel);
                
                // 隐藏2s和2p轨道
                sOrbital.parentElement.style.display = 'none';
                p1Orbital.parentElement.style.display = 'none';
                p2Orbital.parentElement.style.display = 'none';
                p3Orbital.parentElement.style.display = 'none';
            } else if (step >= 4) {
                // 步骤4-6：显示杂化轨道并填入电子
                hybrid1.parentElement.style.display = 'flex';
                hybrid2.parentElement.style.display = 'flex';
                hybrid3.parentElement.style.display = 'flex';
                hybrid4.parentElement.style.display = 'flex';
                
                // 为杂化轨道填入电子
                hybrid1.innerHTML = '<div class="orbital-label">sp³</div><div class="electron up" style="left: 20px;">↑</div>';
                hybrid2.innerHTML = '<div class="orbital-label">sp³</div><div class="electron up" style="left: 20px;">↑</div>';
                hybrid3.innerHTML = '<div class="orbital-label">sp³</div><div class="electron up" style="left: 20px;">↑</div>';
                hybrid4.innerHTML = '<div class="orbital-label">sp³</div><div class="electron up" style="left: 20px;">↑</div>';
                
                // 显示原始轨道能量位置
                const originalOrbitals = document.getElementById('originalOrbitals');
                
                // 添加2p轨道（最高能量）
                const pLevel = document.createElement('div');
                pLevel.className = 'energy-level';
                pLevel.innerHTML = `
                    <div class="energy-label" style="color: rgba(179, 199, 255, 0.5)">2p轨道</div>
                    <div class="energy-line" style="background: rgba(255, 255, 255, 0.15)"></div>
                    <div class="orbital-box" style="border-color: rgba(255, 0, 0, 0.5); background: rgba(255, 0, 0, 0.1)">
                        <div class="orbital-label" style="color: rgba(179, 199, 255, 0.5)">2pₓ</div>
                    </div>
                    <div class="orbital-box" style="border-color: rgba(0, 255, 0, 0.5); background: rgba(0, 255, 0, 0.1)">
                        <div class="orbital-label" style="color: rgba(179, 199, 255, 0.5)">2pᵧ</div>
                    </div>
                    <div class="orbital-box" style="border-color: rgba(0, 0, 255, 0.5); background: rgba(0, 0, 255, 0.1)">
                        <div class="orbital-label" style="color: rgba(179, 199, 255, 0.5)">2p_z</div>
                    </div>
                `;
                originalOrbitals.appendChild(pLevel);
                
                // 添加2s轨道（最低能量）
                const sLevel = document.createElement('div');
                sLevel.className = 'energy-level';
                sLevel.innerHTML = `
                    <div class="energy-label" style="color: rgba(179, 199, 255, 0.5)">2s</div>
                    <div class="energy-line" style="background: rgba(255, 255, 255, 0.15)"></div>
                    <div class="orbital-box" style="border-color: rgba(106, 138, 255, 0.5); background: rgba(106, 138, 255, 0.1)">
                        <div class="orbital-label" style="color: rgba(179, 199, 255, 0.5)">2s</div>
                    </div>
                `;
                originalOrbitals.appendChild(sLevel);
                
                // 隐藏2s和2p轨道
                sOrbital.parentElement.style.display = 'none';
                p1Orbital.parentElement.style.display = 'none';
                p2Orbital.parentElement.style.display = 'none';
                p3Orbital.parentElement.style.display = 'none';
            }
        }
        
        // 动画循环
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // 自动旋转场景（如果没有鼠标控制）
            if (!isMouseDown) {
                rotationAngle += 0.005;
            }
            scene.rotation.y = rotationAngle;
            
            // 杂化步骤的旋转
            hybridRotationAngle += 0.005;
            hybridScenes.forEach(scene => {
                scene.rotation.y = hybridRotationAngle;
            });
            
            // 渲染主场景
            renderer.render(scene, camera);
            
            // 渲染杂化步骤的场景
            hybridRenderers.forEach((renderer, index) => {
                renderer.render(hybridScenes[index], hybridCameras[index]);
            });
        }
        
        // 窗口大小调整
        function onWindowResize() {
            const container = document.getElementById('threeCanvas');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
            
            // 调整杂化步骤的渲染器大小
            hybridRenderers.forEach((renderer, index) => {
                const canvasId = ['sOrbitalCanvas', 'pxOrbitalCanvas', 'pyOrbitalCanvas', 'pzOrbitalCanvas', 
                                 'hybrid1Canvas', 'hybrid2Canvas', 'hybrid3Canvas', 'hybrid4Canvas'][index];
                const container = document.getElementById(canvasId);
                const width = container.clientWidth;
                const height = container.clientHeight;
                
                hybridCameras[index].aspect = width / height;
                hybridCameras[index].updateProjectionMatrix();
                renderer.setSize(width, height);
            });
        }
        
        // 步骤管理
        function goToStep(stepNum) {
            currentStep = stepNum;
            
            // 更新步骤指示器
            stepIndicators.forEach(step => {
                const stepIndex = parseInt(step.getAttribute('data-step'));
                if (stepIndex === stepNum) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
            
            // 更新步骤内容
            stepContents.forEach(content => {
                if (content.id === `step${stepNum}`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            // 更新场景
            updateScene();
        }
        
        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            initThreeJS();
            
            // 获取DOM元素并存储在全局变量中
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const resetBtn = document.getElementById('resetBtn');
            const autoBtn = document.getElementById('autoBtn');
            stepIndicators = document.querySelectorAll('.step');
            stepContents = document.querySelectorAll('.step-content');
            
            // 按钮事件监听
            prevBtn.addEventListener('click', () => {
                stopAutoPlay();
                autoBtn.textContent = '自动演示';
                if (currentStep > 1) {
                    goToStep(currentStep - 1);
                }
            });
            
            nextBtn.addEventListener('click', () => {
                stopAutoPlay();
                autoBtn.textContent = '自动演示';
                if (currentStep < totalSteps) {
                    goToStep(currentStep + 1);
                }
            });
            
            resetBtn.addEventListener('click', () => {
                stopAutoPlay();
                autoBtn.textContent = '自动演示';
                goToStep(1);
            });
            
            autoBtn.addEventListener('click', () => {
                if (autoPlayInterval) {
                    stopAutoPlay();
                    autoBtn.textContent = '自动演示';
                } else {
                    startAutoPlay();
                    autoBtn.textContent = '停止演示';
                }
            });
            
            // 步骤指示器点击事件
            stepIndicators.forEach(step => {
                step.addEventListener('click', () => {
                    const stepNum = parseInt(step.getAttribute('data-step'));
                    goToStep(stepNum);
                });
            });
            
            // 自动播放
            function startAutoPlay() {
                autoPlayInterval = setInterval(() => {
                    if (currentStep < totalSteps) {
                        goToStep(currentStep + 1);
                    } else {
                        stopAutoPlay();
                        autoBtn.textContent = '自动演示';
                    }
                }, 4000);
            }
            
            function stopAutoPlay() {
                if (autoPlayInterval) {
                    clearInterval(autoPlayInterval);
                    autoPlayInterval = null;
                }
            }
            
            // 初始更新场景
            updateScene();
        });
    </script>
</body>
</html>